package vulnerability

import (
	"context"
	"fmt"

	v1 "github.com/stackrox/rox/generated/api/v1"
	"google.golang.org/grpc"
)

// resolveClusterID resolves a cluster name to its ID.
// Returns error if cluster name is not found or if API call fails.
func resolveClusterID(ctx context.Context, conn *grpc.ClientConn,
	clusterID string, clusterName string) (string, error) {
	// Cluster ID has priority.
	if clusterID != "" {
		return clusterID, nil
	}

	if clusterName == "" {
		return "", nil
	}

	client := v1.NewClustersServiceClient(conn)

	// Use query to filter by cluster name server-side
	query := fmt.Sprintf("Cluster:%q", clusterName)

	resp, err := client.GetClusters(ctx, &v1.GetClustersRequest{
		Query: query,
	})
	if err != nil {
		return "", fmt.Errorf("failed to fetch clusters: %w", err)
	}

	clusters := resp.GetClusters()
	if len(clusters) == 0 {
		return "", fmt.Errorf("cluster with name %q not found", clusterName)
	}

	// Return the first matching cluster's ID
	return clusters[0].GetId(), nil
}
